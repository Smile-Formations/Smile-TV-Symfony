## Overview

### Operations in Doctrine are handled by different mechanisms:

- The EntityManager is the main entrypoint for entities
  - Its UnitOfWork keeps track of any changes in the entities, new or known ones
  - It commits the requests once a flush is asked and the changes are calculated
- The repositories handle the operations on your entities
  - Repositories provide an intermediate layer between your domain logic and data mapping
  - You can use them to write custom queries
  - Each defined entity in your application generally has its own repository

![6.4.1](../assets/06-Doctrine/4-Requests%20in%20database/6.4.1.png)

---

## New data

To save a new entity in the database to be written as a new line, your first have to make it known to the EntityManager. This operation is called `persist`.
You can then `flush` every waiting operation to actually save your entity in the database. This will give you access to the entity’s identifier (id).

With attributes (recommended):

![6.4.2](../assets/06-Doctrine/4-Requests%20in%20database/6.4.2.png)

With annotations:

![6.4.3](../assets/06-Doctrine/4-Requests%20in%20database/6.4.3.png)

---

## Repositories

- Instead of using the EntityManager, you can use your entity’s Repository.
- Repositories are classes meant to store all operations relating to one specific type of entity.
- They contain a number of method stubs common to every repository.

Repository base methods:
- find methods:
  - `find($id)`, `findAll()`
  - `findBy`, `findOneBy` which take an array of criteria as arguments
  - `findBy{Property}`, `findOneBy{Property}` magic methods which take the criteria as argument
- `add` and `remove` (only with repositories generated by the MakerBundle) which take an optional boolean parameter `flush` (default `false`) 

Save an entity with attributes and repository:

![6.4.4](../assets/06-Doctrine/4-Requests%20in%20database/6.4.4.png)

## Retrieve data

With attributes (recommended):

![6.4.5](../assets/06-Doctrine/4-Requests%20in%20database/6.4.5.png)

With annotations:

![6.4.6](../assets/06-Doctrine/4-Requests%20in%20database/6.4.6.png)

---

## Custom requests

If you need custom queries, you can write them in your repositories three different ways:

- In plain SQL
- Using Doctrine Query Language (DQL - language using objects)
- Using a Query Builder

## Custom DQL request

![6.4.7](../assets/06-Doctrine/4-Requests%20in%20database/6.4.7.png)

## Alternatively: use a query builder 

![6.4.8](../assets/06-Doctrine/4-Requests%20in%20database/6.4.8.png)

---

## Exercises

- Update your “app_movie_details” page to retrieve movies from your database.
- Create a back office for movies with `make:crud` (tip: generate it in the `Controller\Admin` namespace).
- (optional) Update the last section of your homepage to pick only 6 newest movies from your database.
